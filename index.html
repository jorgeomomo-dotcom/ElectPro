<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProElec V12 | متصل بالسحابة ☁️</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* نفس التصميم السابق (لم يتغير) */
        :root { --bg-color: #e0e5ec; --text-main: #2d3748; --primary: #4d79ff; --success: #219653; --danger: #eb5757; --gold: #f59e0b; --shadow-light: -9px -9px 16px rgba(255,255,255, 0.8); --shadow-dark: 9px 9px 16px rgba(163,177,198, 0.6); --inner-shadow: inset 6px 6px 10px 0 rgba(163,177,198, 0.7), inset -6px -6px 10px 0 rgba(255,255,255, 0.8); }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); font-family: 'Cairo', sans-serif; color: var(--text-main); min-height: 100vh; padding-bottom: 80px; }
        .neu-card { background-color: var(--bg-color); box-shadow: var(--shadow-dark), var(--shadow-light); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2); position: relative;}
        .neu-input { width: 100%; border: none; background: var(--bg-color); box-shadow: var(--inner-shadow); border-radius: 12px; padding: 12px 15px; font-family: 'Cairo'; font-size: 14px; transition: 0.3s; }
        .neu-btn { border: none; background: var(--bg-color); box-shadow: var(--shadow-dark), var(--shadow-light); border-radius: 12px; padding: 10px 20px; color: var(--primary); font-weight: 700; font-family: 'Cairo'; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .neu-btn:active { box-shadow: var(--inner-shadow); transform: scale(0.98); }
        .neu-btn.primary { color: var(--primary); } .neu-btn.danger { color: var(--danger); } .neu-btn.success { color: var(--success); } .neu-btn.small { padding: 6px 12px; font-size: 12px; border-radius: 8px; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .tabs { display: flex; gap: 15px; margin-bottom: 25px; overflow-x: auto; padding: 10px 5px; }
        .tab-btn { flex: 1; min-width: 100px; white-space: nowrap; }
        .tab-btn.active { box-shadow: var(--inner-shadow); color: var(--primary); }
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        .form-group { flex: 1; }
        label { display: block; margin-bottom: 6px; font-size: 12px; font-weight: 600; color: #718096; }
        .table-wrapper { overflow-x: auto; border-radius: 12px; background: rgba(255,255,255,0.4); padding: 5px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: right; padding: 12px; color: #718096; font-size: 13px; border-bottom: 2px solid rgba(0,0,0,0.05); }
        td { padding: 10px; font-size: 14px; border-bottom: 1px solid rgba(0,0,0,0.05); vertical-align: middle; }
        .profit-badge { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .hidden { display: none !important; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(224,229,236,0.9); z-index:999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        
        /* مؤشر حالة الاتصال */
        .status-indicator { position: fixed; bottom: 20px; left: 20px; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 100; box-shadow: var(--shadow-dark); }
        .status-online { background: #dcfce7; color: #166534; }
        .status-offline { background: #fee2e2; color: #991b1b; }

        @media print { .no-print, .neu-btn, .tabs, .status-indicator { display: none !important; } body { background: white; } .neu-card { box-shadow: none; border: none; } }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <i class="fa-solid fa-cloud-arrow-down fa-3x" style="color:var(--primary); margin-bottom:20px;"></i>
    <p>جاري تحميل بياناتك من السحابة...</p>
</div>

<div id="statusIndicator" class="status-indicator status-online hidden">
    <i class="fa-solid fa-wifi"></i> متصل
</div>

<div class="container">
    <div class="app-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <div>
            <h1 style="color:var(--primary); font-size:22px;"><i class="fa-solid fa-bolt"></i> ProElec <span style="font-size:12px; color:var(--success);">Cloud</span></h1>
        </div>
        <div class="no-print">
            <button class="neu-btn" id="saveBtn" onclick="forceSave()" title="حفظ الآن">
                <i class="fa-solid fa-floppy-disk"></i>
            </button>
        </div>
    </div>

    <div class="tabs no-print">
        <button class="neu-btn tab-btn active" onclick="switchTab('dashboard')"><i class="fa-solid fa-calculator"></i> الفوترة</button>
        <button class="neu-btn tab-btn" onclick="switchTab('catalog')"><i class="fa-solid fa-boxes-stacked"></i> المخزن</button>
        <button class="neu-btn tab-btn" onclick="switchTab('customers')"><i class="fa-solid fa-users"></i> الزبائن</button>
    </div>

    <div id="dashboard-view">
        <div class="neu-card">
            <div class="form-row">
                <div class="form-group" style="flex:2">
                    <label>الزبون / المشروع</label>
                    <select id="customerSelect" class="neu-input" onchange="window.app.loadCustomerData()">
                        <option value="">-- اختر المشروع --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="neu-btn" onclick="window.app.addNewCustomer()"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
        </div>

        <div class="neu-card no-print">
            <h3>إضافة بند</h3>
            <div id="quickCatalog" style="display:flex; gap:10px; overflow-x:auto; padding:10px 0; margin-bottom:15px;"></div>
            
            <div class="form-row">
                <input type="text" id="itemName" class="neu-input" placeholder="البيان" style="flex:2">
                <input type="number" id="itemQty" class="neu-input" placeholder="العدد" value="1" style="flex:1">
            </div>
            <div class="form-row">
                <input type="number" id="itemPrice" class="neu-input" placeholder="سعر البيع">
                <button class="neu-btn primary" onclick="window.app.addItem()"><i class="fa-solid fa-check"></i> إضافة</button>
            </div>
        </div>

        <div class="neu-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>الفاتورة</h3>
                <span id="itemsCount" style="font-size:12px; color:#888;">0 بنود</span>
            </div>
            <div class="table-wrapper">
                <table id="invoiceTable">
                    <thead><tr><th>البيان</th><th>العدد</th><th>السعر</th><th>الإجمالي</th><th class="no-print">حذف</th></tr></thead>
                    <tbody id="invoiceBody"></tbody>
                </table>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:space-between; font-size:18px; font-weight:bold;">
                <span>المجموع:</span>
                <span id="grandTotalDisplay">0.00 د.ج</span>
            </div>
        </div>
    </div>

    <div id="catalog-view" class="hidden">
        <div class="neu-card">
            <h3>إدارة المخزن</h3>
            <div class="form-row">
                <input type="text" id="catName" class="neu-input" placeholder="اسم المادة">
                <input type="number" id="catPrice" class="neu-input" placeholder="سعر البيع">
                <button class="neu-btn primary" onclick="window.app.addToCatalog()">حفظ</button>
            </div>
            <div class="table-wrapper">
                <table id="catalogTable">
                    <thead><tr><th>المادة</th><th>السعر</th><th>حذف</th></tr></thead>
                    <tbody id="catalogBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="customers-view" class="hidden">
        <div class="neu-card"><h3>قائمة الزبائن</h3><div id="customersList"></div></div>
    </div>
</div>

<script type="module">
    // 1. استيراد مكتبات فايربيس من الانترنت
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
const firebaseConfig = {

  apiKey: "AIzaSyBYYgIJsIO7KwfQp3w4CMRM73F7qC_4qzk",

  authDomain: "proelec-bf23f.firebaseapp.com",

  projectId: "proelec-bf23f",

  storageBucket: "proelec-bf23f.firebasestorage.app",

  messagingSenderId: "691873146420",

  appId: "1:691873146420:web:e822e57bd592bd47880c61",

  measurementId: "G-KPE5PH6K8Z"
};
    // -----------------------------------------------------------------------

    // تهيئة فايربيس
    const app = initializeApp(firebaseConfig);
    const dbFirestore = getFirestore(app);

    // متغيرات التطبيق
    let localDB = {
        customers: [],
        catalog: [
            {id: 1, name: 'تركيب مأخذ (Prise)', price: 600},
            {id: 2, name: 'نقطة إنارة (Simple)', price: 500}
        ],
        invoices: {},
        payments: {}
    };
    let currentCustId = null;

    // --- دوال قاعدة البيانات (Firestore) ---
    
    // دالة جلب البيانات عند الفتح
    async function loadFromCloud() {
        const docRef = doc(dbFirestore, "app_data", "main_db"); // اسم الملف في القاعدة
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                localDB = docSnap.data();
                console.log("تم تحميل البيانات من السحابة!");
            } else {
                console.log("لا توجد بيانات سابقة، جاري إنشاء قاعدة جديدة...");
                saveToCloud(); // إنشاء ملف جديد
            }
        } catch (error) {
            console.error("خطأ في الاتصال:", error);
            alert("تنبيه: تعذر الاتصال بالسيرفر. تأكد من الإنترنت.");
        } finally {
            document.getElementById('loader').classList.add('hidden');
            renderUI();
        }
    }

    // دالة الحفظ في السحابة
    async function saveToCloud() {
        const statusEl = document.getElementById('statusIndicator');
        statusEl.classList.remove('hidden');
        statusEl.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> جاري الحفظ...';
        
        try {
            await setDoc(doc(dbFirestore, "app_data", "main_db"), localDB);
            statusEl.innerHTML = '<i class="fa-solid fa-check"></i> تم الحفظ';
            statusEl.className = 'status-indicator status-online';
            setTimeout(() => statusEl.classList.add('hidden'), 2000);
        } catch (error) {
            console.error("خطأ في الحفظ:", error);
            statusEl.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> فشل الحفظ!';
            statusEl.className = 'status-indicator status-offline';
        }
    }

    // --- منطق التطبيق (مشابه للكود السابق) ---
    
    window.app = {
        addNewCustomer: () => {
            const name = prompt('اسم المشروع الجديد:');
            if(!name) return;
            const newC = { id: Date.now(), name: name };
            localDB.customers.push(newC);
            localDB.invoices[newC.id] = [];
            currentCustId = newC.id;
            saveToCloud();
            renderUI();
        },

        loadCustomerData: () => {
            currentCustId = document.getElementById('customerSelect').value;
            if(currentCustId) {
                currentCustId = parseInt(currentCustId);
                renderInvoiceTable();
            }
        },

        addItem: (catalogItem = null) => {
            if(!currentCustId) { alert('اختر مشروعاً أولاً!'); return; }
            let item = {};
            
            if(catalogItem) {
                item = { ...catalogItem, qty: 1, id: Date.now() };
            } else {
                const name = document.getElementById('itemName').value;
                const price = parseFloat(document.getElementById('itemPrice').value);
                const qty = parseFloat(document.getElementById('itemQty').value) || 1;
                if(!name || !price) return;
                item = { id: Date.now(), name, price, qty };
                
                // تنظيف الحقول
                document.getElementById('itemName').value = '';
                document.getElementById('itemPrice').value = '';
                document.getElementById('itemQty').value = 1;
            }

            // تجميع الكميات إذا العنصر مكرر
            if(!localDB.invoices[currentCustId]) localDB.invoices[currentCustId] = [];
            const exist = localDB.invoices[currentCustId].find(i => i.name === item.name && i.price === item.price);
            if(exist) {
                exist.qty += item.qty;
            } else {
                localDB.invoices[currentCustId].push(item);
            }
            
            saveToCloud();
            renderInvoiceTable();
        },

        deleteItem: (idx) => {
            localDB.invoices[currentCustId].splice(idx, 1);
            saveToCloud();
            renderInvoiceTable();
        },

        addToCatalog: () => {
            const name = document.getElementById('catName').value;
            const price = parseFloat(document.getElementById('catPrice').value);
            if(!name || !price) return;
            localDB.catalog.push({id: Date.now(), name, price});
            document.getElementById('catName').value = '';
            document.getElementById('catPrice').value = '';
            saveToCloud();
            renderCatalog();
        },

        removeFromCatalog: (idx) => {
            localDB.catalog.splice(idx, 1);
            saveToCloud();
            renderCatalog();
        }
    };

    // --- دوال العرض (Rendering) ---
    function renderUI() {
        renderCustomersSelect();
        renderCatalog();
        if(currentCustId) renderInvoiceTable();
    }

    function renderCustomersSelect() {
        const sel = document.getElementById('customerSelect');
        sel.innerHTML = '<option value="">-- اختر المشروع --</option>';
        localDB.customers.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            sel.appendChild(opt);
        });
        if(currentCustId) sel.value = currentCustId;
    }

    function renderInvoiceTable() {
        const tbody = document.getElementById('invoiceBody');
        tbody.innerHTML = '';
        let total = 0;
        const items = localDB.invoices[currentCustId] || [];
        
        items.forEach((item, idx) => {
            const lineTotal = item.qty * item.price;
            total += lineTotal;
            tbody.innerHTML += `
                <tr>
                    <td>${item.name}</td>
                    <td style="text-align:center">${item.qty}</td>
                    <td>${item.price.toLocaleString()}</td>
                    <td style="font-weight:bold">${lineTotal.toLocaleString()}</td>
                    <td class="no-print" style="text-align:center">
                        <button class="neu-btn danger small" onclick="window.app.deleteItem(${idx})">x</button>
                    </td>
                </tr>`;
        });
        document.getElementById('grandTotalDisplay').innerText = total.toLocaleString() + ' د.ج';
        document.getElementById('itemsCount').innerText = items.length + ' بنود';
    }

    function renderCatalog() {
        const tbody = document.getElementById('catalogBody');
        const quickDiv = document.getElementById('quickCatalog');
        tbody.innerHTML = '';
        quickDiv.innerHTML = '';
        
        localDB.catalog.forEach((item, idx) => {
            // الجدول
            tbody.innerHTML += `<tr><td>${item.name}</td><td>${item.price}</td><td><button class="neu-btn danger small" onclick="window.app.removeFromCatalog(${idx})">x</button></td></tr>`;
            // الأزرار السريعة
            const btn = document.createElement('button');
            btn.className = 'neu-btn small';
            btn.innerText = item.name;
            btn.onclick = () => window.app.addItem(item);
            quickDiv.appendChild(btn);
        });
    }

    // دوال مساعدة عامة
    window.switchTab = (tabId) => {
        document.querySelectorAll('[id$="-view"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(tabId + '-view').classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');
    };
    
    window.forceSave = () => saveToCloud();

    // تشغيل التطبيق
    loadFromCloud();

</script>

</body>
</html>
